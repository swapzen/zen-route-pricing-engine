  [1m[35mSQL (0.5ms)[0m  [1m[35mSET search_path TO public[0m
  [1m[35m (463.9ms)[0m  [1m[35mCREATE DATABASE "zen_route_pricing_development" ENCODING = 'unicode'[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public[0m
  [1m[35m (81.7ms)[0m  [1m[35mCREATE DATABASE "zen_route_pricing_test" ENCODING = 'unicode'[0m
  [1m[35m (52.6ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY)[0m
  [1m[35m (39.2ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[36mActiveRecord::InternalMetadata Load (3.1ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (6.9ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'development', '2026-01-13 18:54:53.554174+0000', '2026-01-13 18:54:53.554177+0000') RETURNING "key"[0m
  [1m[36mActiveRecord::SchemaMigration Load (2.6ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Migrating to CreatePricingTables (20260113174247)
  [1m[35m (37.6ms)[0m  [1m[35mCREATE TABLE "pricing_configs" ("id" uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, "city_code" character varying NOT NULL, "vehicle_type" character varying NOT NULL, "timezone" character varying DEFAULT 'Asia/Kolkata' NOT NULL, "base_fare_paise" int NOT NULL, "min_fare_paise" int NOT NULL, "base_distance_m" int DEFAULT '0' NOT NULL, "per_km_rate_paise" int NOT NULL, "vehicle_multiplier" decimal(6,3) DEFAULT '1.0', "city_multiplier" decimal(6,3) DEFAULT '1.0', "surge_multiplier" decimal(6,3) DEFAULT '1.0', "variance_buffer_pct" decimal(6,3) DEFAULT '0.0', "variance_buffer_min_paise" int DEFAULT '0', "variance_buffer_max_paise" int DEFAULT '0', "high_value_threshold_paise" int DEFAULT '0', "high_value_buffer_pct" decimal(6,3) DEFAULT '0.0', "high_value_buffer_min_paise" int DEFAULT '0', "min_margin_pct" decimal(6,3) DEFAULT '0.0', "min_margin_flat_paise" int DEFAULT '0', "active" boolean DEFAULT TRUE, "version" int DEFAULT '1', "effective_from" timestamp(6), "effective_until" timestamp(6), "created_by_id" bigint, "notes" text, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1267.4ms)[0m  [1m[35mCREATE UNIQUE INDEX "idx_on_city_code_vehicle_type_version_008f27eb85" ON "pricing_configs" ("city_code", "vehicle_type", "version")[0m
  [1m[35m (1351.1ms)[0m  [1m[35mCREATE INDEX "idx_pricing_configs_current" ON "pricing_configs" ("city_code", "vehicle_type", "active", "effective_from")[0m
  [1m[35m (66.1ms)[0m  [1m[35mCREATE TABLE "pricing_surge_rules" ("id" uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, "pricing_config_id" uuid NOT NULL, "rule_type" character varying NOT NULL, "condition_json" jsonb DEFAULT '{}' NOT NULL, "multiplier" decimal(6,3) NOT NULL, "priority" int DEFAULT '100', "active" boolean DEFAULT TRUE, "created_by_id" bigint, "notes" text, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (414.2ms)[0m  [1m[35mALTER TABLE "pricing_surge_rules" ADD CONSTRAINT "fk_rails_f3ea02dbb6"
FOREIGN KEY ("pricing_config_id")
  REFERENCES "pricing_configs" ("id")
[0m
  [1m[35m (1248.6ms)[0m  [1m[35mCREATE INDEX "idx_pricing_surge_rules_active" ON "pricing_surge_rules" ("pricing_config_id", "active", "priority")[0m
  [1m[35m (1213.6ms)[0m  [1m[35mCREATE INDEX "index_pricing_surge_rules_on_rule_type" ON "pricing_surge_rules" ("rule_type")[0m
  [1m[35m (40.2ms)[0m  [1m[35mCREATE TABLE "pricing_quotes" ("id" uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, "request_id" character varying, "city_code" character varying NOT NULL, "vehicle_type" character varying NOT NULL, "pickup_raw_lat" decimal(10,6), "pickup_raw_lng" decimal(10,6), "drop_raw_lat" decimal(10,6), "drop_raw_lng" decimal(10,6), "pickup_norm_lat" decimal(10,6), "pickup_norm_lng" decimal(10,6), "drop_norm_lat" decimal(10,6), "drop_norm_lng" decimal(10,6), "distance_m" int, "duration_s" int, "route_provider" character varying, "route_cache_key" character varying, "price_paise" int NOT NULL, "price_confidence" character varying DEFAULT 'estimated', "pricing_version" character varying DEFAULT 'v1', "breakdown_json" jsonb DEFAULT '{}', "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1226.4ms)[0m  [1m[35mCREATE INDEX "index_pricing_quotes_on_request_id" ON "pricing_quotes" ("request_id")[0m
  [1m[35m (1242.7ms)[0m  [1m[35mCREATE INDEX "index_pricing_quotes_on_city_code" ON "pricing_quotes" ("city_code")[0m
  [1m[35m (1226.4ms)[0m  [1m[35mCREATE INDEX "index_pricing_quotes_on_vehicle_type" ON "pricing_quotes" ("vehicle_type")[0m
  [1m[35m (1212.7ms)[0m  [1m[35mCREATE INDEX "index_pricing_quotes_on_created_at" ON "pricing_quotes" ("created_at")[0m
  [1m[35m (41.1ms)[0m  [1m[35mCREATE TABLE "pricing_actuals" ("id" uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY, "pricing_quote_id" uuid NOT NULL, "vendor" character varying DEFAULT 'porter', "vendor_booking_ref" character varying, "actual_price_paise" int NOT NULL, "notes" text, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (263.2ms)[0m  [1m[35mALTER TABLE "pricing_actuals" ADD CONSTRAINT "fk_rails_6cc4c99dfa"
FOREIGN KEY ("pricing_quote_id")
  REFERENCES "pricing_quotes" ("id")
[0m
  [1m[35m (1230.6ms)[0m  [1m[35mCREATE INDEX "index_pricing_actuals_on_pricing_quote_id" ON "pricing_actuals" ("pricing_quote_id")[0m
  [1m[35m (1237.3ms)[0m  [1m[35mCREATE INDEX "index_pricing_actuals_on_vendor" ON "pricing_actuals" ("vendor")[0m
  [1m[36mActiveRecord::SchemaMigration Create (7.8ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20260113174247') RETURNING "version"[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::SchemaMigration Load (5.9ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (1.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.4ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::SchemaMigration Load (1.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.9ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public[0m
  [1m[35m (2216.2ms)[0m  [1m[35mDROP DATABASE IF EXISTS "swapzen_development"[0m
  [1m[35mSQL (0.1ms)[0m  [1m[35mSET search_path TO public[0m
  [1m[35m (311.4ms)[0m  [1m[35mDROP DATABASE IF EXISTS "swapzen_test"[0m
  [1m[36mPricingConfig Count (145.3ms)[0m  [1m[34mSELECT COUNT(*) FROM "pricing_configs"[0m
  [1m[36mPricingConfig Count (96.4ms)[0m  [1m[34mSELECT COUNT(*) FROM "pricing_configs"[0m
  [1m[36mPricingConfig Load (4.2ms)[0m  [1m[34mSELECT "pricing_configs".* FROM "pricing_configs" WHERE "pricing_configs"."city_code" = $1 AND "pricing_configs"."vehicle_type" = $2 AND "pricing_configs"."active" = $3 AND "pricing_configs"."effective_until" IS NULL AND (effective_from <= $4) ORDER BY "pricing_configs"."version" DESC LIMIT $5[0m  [["city_code", "hyd"], ["vehicle_type", "two_wheeler"], ["active", true], [nil, "2026-01-13 19:04:13.961311+0000"], ["LIMIT", 1]]
  [1m[36mPricingSurgeRule Load (1.5ms)[0m  [1m[34mSELECT "pricing_surge_rules".* FROM "pricing_surge_rules" WHERE "pricing_surge_rules"."pricing_config_id" = $1 AND "pricing_surge_rules"."active" = $2[0m  [["pricing_config_id", "0673d6af-be02-43f0-a8f0-9e87d97fba59"], ["active", true]]
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mBEGIN[0m
  [1m[36mPricingQuote Create (1.9ms)[0m  [1m[32mINSERT INTO "pricing_quotes" ("request_id", "city_code", "vehicle_type", "pickup_raw_lat", "pickup_raw_lng", "drop_raw_lat", "drop_raw_lng", "pickup_norm_lat", "pickup_norm_lng", "drop_norm_lat", "drop_norm_lng", "distance_m", "duration_s", "route_provider", "route_cache_key", "price_paise", "price_confidence", "pricing_version", "breakdown_json", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21) RETURNING "id"[0m  [["request_id", nil], ["city_code", "hyd"], ["vehicle_type", "two_wheeler"], ["pickup_raw_lat", "17.447"], ["pickup_raw_lng", "78.3771"], ["drop_raw_lat", "17.3616"], ["drop_raw_lng", "78.4747"], ["pickup_norm_lat", "17.447"], ["pickup_norm_lng", "78.3771"], ["drop_norm_lat", "17.3616"], ["drop_norm_lng", "78.4747"], ["distance_m", 19671], ["duration_s", 2833], ["route_provider", "haversine_fallback"], ["route_cache_key", "[FILTERED]"], ["price_paise", 19000], ["price_confidence", "estimated"], ["pricing_version", "v1"], ["breakdown_json", "{\"base_fare\":2000,\"chargeable_distance_m\":17671,\"chargeable_km\":18,\"distance_component\":14400,\"raw_subtotal\":16400,\"surge_multiplier_applied\":\"1.0\",\"traffic_ratio\":null,\"duration_s\":2833,\"duration_in_traffic_s\":null,\"vehicle_multiplier\":1.0,\"city_multiplier\":1.0,\"after_multipliers\":16400,\"variance_buffer\":820,\"high_value_buffer\":0,\"subtotal_with_buffers\":17220,\"margin_guardrail\":1517,\"price_after_margin\":18737,\"final_price\":19000}"], ["created_at", "2026-01-13 19:04:14.132275+0000"], ["updated_at", "2026-01-13 19:04:14.132275+0000"]]
  [1m[36mTRANSACTION (8.6ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mPricingQuote Load (2.9ms)[0m  [1m[34mSELECT "pricing_quotes".* FROM "pricing_quotes" ORDER BY "pricing_quotes"."id" DESC LIMIT $1[0m  [["LIMIT", 1]]
  [1m[36mPricingConfig Count (107.6ms)[0m  [1m[34mSELECT COUNT(*) FROM "pricing_configs"[0m
  [1m[36mPricingConfig Load (2.1ms)[0m  [1m[34mSELECT "pricing_configs".* FROM "pricing_configs" WHERE "pricing_configs"."city_code" = $1 AND "pricing_configs"."vehicle_type" = $2 AND "pricing_configs"."active" = $3 AND "pricing_configs"."effective_until" IS NULL AND (effective_from <= $4) ORDER BY "pricing_configs"."version" DESC LIMIT $5[0m  [["city_code", "hyd"], ["vehicle_type", "two_wheeler"], ["active", true], [nil, "2026-01-13 19:05:24.899495+0000"], ["LIMIT", 1]]
  [1m[36mPricingSurgeRule Load (1.1ms)[0m  [1m[34mSELECT "pricing_surge_rules".* FROM "pricing_surge_rules" WHERE "pricing_surge_rules"."pricing_config_id" = $1 AND "pricing_surge_rules"."active" = $2[0m  [["pricing_config_id", "0673d6af-be02-43f0-a8f0-9e87d97fba59"], ["active", true]]
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mPricingQuote Create (2.2ms)[0m  [1m[32mINSERT INTO "pricing_quotes" ("request_id", "city_code", "vehicle_type", "pickup_raw_lat", "pickup_raw_lng", "drop_raw_lat", "drop_raw_lng", "pickup_norm_lat", "pickup_norm_lng", "drop_norm_lat", "drop_norm_lng", "distance_m", "duration_s", "route_provider", "route_cache_key", "price_paise", "price_confidence", "pricing_version", "breakdown_json", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21) RETURNING "id"[0m  [["request_id", nil], ["city_code", "hyd"], ["vehicle_type", "two_wheeler"], ["pickup_raw_lat", "17.447"], ["pickup_raw_lng", "78.3771"], ["drop_raw_lat", "17.3616"], ["drop_raw_lng", "78.4747"], ["pickup_norm_lat", "17.447"], ["pickup_norm_lng", "78.3771"], ["drop_norm_lat", "17.3616"], ["drop_norm_lng", "78.4747"], ["distance_m", 19671], ["duration_s", 2833], ["route_provider", "haversine_fallback"], ["route_cache_key", "[FILTERED]"], ["price_paise", 19000], ["price_confidence", "estimated"], ["pricing_version", "v1"], ["breakdown_json", "{\"base_fare\":2000,\"chargeable_distance_m\":17671,\"chargeable_km\":18,\"distance_component\":14400,\"raw_subtotal\":16400,\"surge_multiplier_applied\":\"1.0\",\"traffic_ratio\":null,\"duration_s\":2833,\"duration_in_traffic_s\":null,\"vehicle_multiplier\":1.0,\"city_multiplier\":1.0,\"after_multipliers\":16400,\"variance_buffer\":820,\"high_value_buffer\":0,\"subtotal_with_buffers\":17220,\"margin_guardrail\":1517,\"price_after_margin\":18737,\"final_price\":19000}"], ["created_at", "2026-01-13 19:05:25.150071+0000"], ["updated_at", "2026-01-13 19:05:25.150071+0000"]]
  [1m[36mTRANSACTION (7.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mPricingQuote Load (0.6ms)[0m  [1m[34mSELECT "pricing_quotes".* FROM "pricing_quotes" ORDER BY "pricing_quotes"."id" DESC LIMIT $1[0m  [["LIMIT", 1]]
